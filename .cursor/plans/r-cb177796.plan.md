<!-- cb177796-314d-4aa8-80d0-4b01af869e9f 46ce85bf-d216-4de0-908c-79333432416c -->
# RexLit: Offline‑First UNIX Litigation SDK/CLI

## Scope

- Build `rexlit` under `/Users/bg/Documents/Coding/rex/rexlit/`.
- Pillars: (a) E‑discovery toolkit (ingest → OCR → dedupe → Bates stamp → produce → audit), (b) TX/FL rules & timeline engine (event → computed deadlines → citations → ICS export).
- Philosophy: Offline‑by‑default. All networked features gated behind `--online`.

## Directory layout

- `/Users/bg/Documents/Coding/rex/rexlit/`
                                                                - `pyproject.toml` (Python 3.11; extras: `[ocr-deepseek]`)
                                                                - `README.md`, `LICENSE`
                                                                - `rexlit/__init__.py`
                                                                - `rexlit/cli.py` (Typer entrypoint; subcommands)
                                                                - `rexlit/config.py` (Pydantic settings; XDG; env overrides; `online` flag)
                                                                - `rexlit/utils/` (`hashing.py`, `paths.py`, `time.py`, `zstd.py`)
                                                                - `rexlit/audit/ledger.py` (append‑only JSONL, provenance)
                                                                - `rexlit/ingest/` (`discover.py`, `extract.py`, `normalize.py`)
                                                                - `rexlit/pdf/` (`fitz_ops.py` for stamping/coords; `attachments.py`)
                                                                - `rexlit/ocr/` (`provider.py`; `tesseract.py`; `paddle.py`; `deepseek.py`)
                                                                - `rexlit/ediscovery/` (`dedupe.py`, `pii.py`, `produce.py`)
                                                                - `rexlit/index/` (`build.py`, `search.py`) using `tantivy` (fallback to `whoosh` if needed)
                                                                - `rexlit/rules/` (`engine.py`, `calendar.py`, `export.py`, `tx.yaml`, `fl.yaml`)
                                                                - `rexlit/agent/claude.py` (Claude Agent SDK adapter; strictly under `--online`)
                                                                - `tests/` (pytest; golden outputs; e2e flows)
                                                                - `.claude/CLAUDE.md`, `.claude/settings.local.json`

## CLI surface (approved)

- `rexlit ingest PATH [--watch] [--manifest out.jsonl]`
- `rexlit ocr run PATH [--provider paddle|tesseract|deepseek] [--online]`
- `rexlit bates stamp PATH --prefix ABC --width 7 [--pad 7] [--dry-run]`
- `rexlit dedupe PATH [--near] [--simhash-threshold 0.92]`
- `rexlit index build PATH [--exclude "*.zip"] [--force]`
- `rexlit search 'query' [--json] [--top 50] [--filter custodian=…]`
- `rexlit produce create PATH --name SET1 [--format dat|opticon] [--bates ABC]`
- `rexlit rules calc --jurisdiction TX --event served_petition --date 2025-10-22 [--explain] [--ics out.ics]`
- `rexlit audit export [--jsonl] [--verify]`

## Config and online gating

- Settings precedence: CLI flag > env > config file.
- Env: `REXLIT_ONLINE=0|1`, `ANTHROPIC_API_KEY`, `DEEPSEEK_API_KEY`, optional `DEEPSEEK_API_BASE`.
- Default is offline (`online=False`). Networked features error with actionable message unless `--online`.
```python
# rexlit/config.py (essence)
from pydantic import BaseModel
class Settings(BaseModel):
    online: bool = False
    data_dir: str | None = None

# cli usage
import os, typer
need_online = True
is_online = (ctx.obj.settings.online
             or bool(os.getenv("REXLIT_ONLINE"))
             or online_flag)
if need_online and not is_online:
    typer.secho("This action requires --online (or REXLIT_ONLINE=1). Aborting.", fg=typer.colors.YELLOW)
    raise typer.Exit(code=2)
```


## Audit ledger (append‑only JSONL)

- One JSON object per step; deterministic fields; sha256 for inputs/outputs; tool versions.
- Example entry:
```json
{"ts":"2025-10-22T17:00:00Z","op":"ingest","inputs":["/path/a.pdf"],"outputs":["sha256:…"],"args":{"watch":false},"versions":{"rexlit":"0.1.0","pymupdf":"1.24.9"}}
```


## E‑discovery components

- Ingest/Extract: PyMuPDF (text + coords), pdfminer.six (text fidelity), pdfplumber (tables), python-magic (types), pillow/exifread (images), extract-msg/mail-parser (MSG/EML). Optional `pypff` for PST (best‑effort).
- OCR: default offline providers (`paddle`, `tesseract`); `deepseek` behind optional extras and/or remote under `--online`.
- Dedupe: SHA‑256 exact; near‑dup via `simhash`/`datasketch` w/ threshold; optional `fastcdc-python` chunking.
- Bates: PyMuPDF page stamping; deterministic numbering; dry‑run plan; JSON report.
- Produce: DAT/Opticon generation; path/custodian mapping; content‑addressed output dir; reproducible zstd bundle.
- Index/Search: `tantivy` fields: `path`, `sha256`, `custodian`, `doctype`, `body`; facets; JSONL search output.
- PII: `presidio-analyzer` + `presidio-anonymizer` offline models; redact report.

## Rules & timeline engine

- Rule packs in YAML (TX: `tx.yaml`, FL: `fl.yaml`); clear citations and notes.
- Engine supports offsets, business days, weekends/holidays, time-of-day constraints, chaining, and explain mode.
- Holidays: `python-holidays` (US, TX, FL). ICS export via `ics`.
```yaml
# rexlit/rules/tx.yaml (illustrative snippet)
events:
  served_petition:
    description: Service of petition on defendant
    deadlines:
      - name: answer_due
        cite: "Tex. R. Civ. P. 99(b)"
        offset:
          type: "next_monday_after"
          days: 20
        time: "10:00"
        adjust:
          - skip_weekends: true
          - skip_holidays: ["US", "TX"]
        notes: "Defendant’s answer due"
```


## Claude Agent integration (optional, online only)

- Adapter for summarization/checklists; loads `.claude/CLAUDE.md` via `setting_sources=["project"]` when requested.
- Strictly disabled unless `--online` and `ANTHROPIC_API_KEY` present.

## Packaging and installation

- Install via `pipx install .` or `uv pip install -e .` (dev).
- Extras: `rexlit[ocr-deepseek]` to install `torch`, `transformers`, `flash-attn` when GPU is available.
- Shell completions and manpage generation via Typer helpers.

## Tests

- Golden outputs for: ingest manifests, OCR text snippets, Bates maps, DAT/Opticon manifests, rules calculations (TX/FL), ICS files.
- E2E pipelines on a synthetic/public dataset; property tests for date math.

## Risks & fallbacks

- `tantivy` build issues → fallback to `whoosh` transparently.
- `pypff` platform friction → document optional support; skip in CI.
- GPU‑heavy DeepSeek local inference → keep as optional extra; prefer offline Tesseract/Paddle for demos; optional remote under `--online`.

## Milestones (acceptance criteria)

- M0: Skeleton, config, ledger; ingest (PDF/DOCX/TXT/images); index+search; basic tests.
- M1: OCR (paddle/tesseract), Bates stamping, productions (DAT/Opticon), PII redaction.
- M2: TX rules pack + engine + calendars + explain + ICS; goldens.
- M3: FL rules pack; DeepSeek OCR provider + Claude adapter behind `--online`; manpage/completions.
- M4: Demo script, sample dataset, README (defensibility), packaging; all tests green.

### To-dos

- [ ] Scaffold package, pyproject, Typer CLI, config, utils
- [ ] Implement append-only JSONL audit ledger with hashing and versions
- [ ] Implement ingest discovery and text/metadata extraction (PDF, DOCX, TXT, images)
- [ ] Implement tantivy index build/search with JSON output
- [ ] Set up pytest and golden-output harness
- [ ] Add Tesseract/Paddle OCR providers and CLI integration
- [ ] Implement deterministic Bates stamping with PyMuPDF
- [ ] Generate DAT/Opticon productions with content-addressed outputs
- [ ] Integrate Presidio offline PII detection/redaction
- [ ] Build rules engine, calendars, explain, and ICS export
- [ ] Author TX rule pack with citations and tests
- [ ] Author FL rule pack with citations and tests
- [ ] Gate --online; wire DeepSeek OCR and Claude Agent SDK
- [ ] Write README, manpage/completions, demo script, sample dataset